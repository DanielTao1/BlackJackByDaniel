<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ’è±ªå21ç‚¹ğŸ’µ-æ‰‹æœºç‰ˆ</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a1a;
            color: #fff;
            margin: 0;
            padding: 10px;
            min-height: 100vh;
        }

        .container {
            display: flex;
            flex-direction: column;
            margin: 10px 0;
        }

        /* ç™»å½•æ¡†æ ·å¼ */
        .auth-box {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2a2a2a;
            width: 90%;
            max-width: 300px;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
        }

        /* æ¸¸æˆåŒºåŸŸæ ·å¼ */
        .game-area {
            width: 100%;
            background: #2a2a2a;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            box-sizing: border-box;
        }

        .bet-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 10px 0;
        }

        .bet-buttons button {
            padding: 12px 8px;
            font-size: 14px;
            background: #4CAF50;
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }

        input {
            padding: 10px;
            margin: 5px;
            width: 100%;
            box-sizing: border-box;
            background: #333;
            border: 1px solid #444;
            color: white;
            border-radius: 8px;
        }

        /* å¡ç‰Œæ ·å¼ */
        .cards {
            min-height: 80px;
            padding: 10px;
            background: #333;
            border-radius: 8px;
            margin: 8px 0;
        }

        .card-symbol {
            margin: 3px;
            padding: 6px;
            background: #444;
            border-radius: 5px;
            display: inline-block;
            font-size: 14px;
        }

        /* è´§å¸æ˜¾ç¤º */
        .money {
            color: #FFD700;
            font-size: 20px;
            margin: 15px 0;
        }

        /* ç­‰çº§ç³»ç»Ÿ */
        .level-info {
            color: #4CAF50;
            font-size: 16px;
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .progress-bar {
            width: 80%;
            height: 8px;
            background: #333;
            border-radius: 5px;
            margin: 5px auto;
        }

        .progress {
            height: 100%;
            background: #4CAF50;
            border-radius: 5px;
            transition: width 0.3s;
        }

        /* é’»çŸ³æ ·å¼ */
        .diamond-info {
            color: #00BFFF;
            font-size: 16px;
        }

        /* æ¸¸æˆæ§åˆ¶æŒ‰é’® */
        #game-controls button {
            padding: 15px 20px;
            margin: 5px;
            font-size: 16px;
            flex: 1;
            min-width: 45%;
            border-radius: 8px;
        }

        .double-button {
            background: #FF9800 !important;
        }

        /* é€šç”¨æŒ‰é’®æ ·å¼ */
        button {
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* æ ‡é¢˜æ ·å¼ */
        h1 { font-size: 24px; margin: 10px 0; }
        h2 { font-size: 20px; }
        h3 { font-size: 18px; margin: 8px 0; }

        /* ä¾§è¾¹æ³¨é€‰é¡¹ */
        .sidebet-options {
            margin: 10px 0;
            padding: 10px;
            background: #333;
            border-radius: 8px;
        }

        .sidebet-options label {
            display: block;
            margin: 8px 0;
            font-size: 14px;
        }

        .sidebet-options input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (min-width: 768px) {
            .bet-buttons { grid-template-columns: repeat(3, 1fr); }
            #game-controls button { min-width: 30%; }
        }

        /* æµ®åŠ¨åŠ¨ç”» */
        @keyframes floatUp {
            0% { top: 20%; opacity: 1; }
            100% { top: 10%; opacity: 0; }
        }
        
        /* å•†åŸæ ·å¼ */
        #shop-button {
            position: fixed;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            z-index: 999;
            background: rgba(0,191,255,0.8);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            text-align: center;
            line-height: 40px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .shop-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(42,42,42,0.95);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            width: 90%;
            max-width: 400px;
        }

        .shop-content {
            text-align: center;
        }

        .exchange-item {
            margin: 15px 0;
            padding: 10px;
            background: #333;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exchange-item button {
            padding: 8px 15px;
            background: #4CAF50;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .close-shop {
            margin-top: 15px;
            padding: 10px 20px;
            background: #FF5722;
            border-radius: 8px;
            width: 100%;
        }

        /* æ–°å¢åŠŸèƒ½æŒ‰é’®æ ·å¼ */
        .function-button {
            position: fixed;
            top: 15px;
            font-size: 24px;
            cursor: pointer;
            z-index: 999;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            text-align: center;
            line-height: 40px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        #ad-button { 
            right: 70px;
            background: rgba(255,87,34,0.8);
        }

        #redeem-button {
            right: 120px;
            background: rgba(76,175,80,0.8);
        }

        /* å¼¹çª—æ ·å¼ */
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(42,42,42,0.95);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            width: 90%;
            max-width: 400px;
        }

        .popup-content {
            text-align: center;
        }

        .popup input[type="text"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #333;
            border: 1px solid #444;
            color: white;
            border-radius: 8px;
        }

        .popup button {
            padding: 12px 24px;
            margin: 10px 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .ad-button { background: #FF5722; color: white; }
        .redeem-button { background: #4CAF50; color: white; }
        .close-button {
            background: #666;
            color: white;
            margin-top: 15px;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- åŠŸèƒ½æŒ‰é’® -->
    <div id="shop-button" class="function-button" onclick="toggleShop()" title="é’»çŸ³å•†åŸ">ğŸ’</div>
    <div id="ad-button" class="function-button" onclick="toggleAd()" title="è§‚çœ‹å¹¿å‘Š">ğŸ“º</div>
    <div id="redeem-button" class="function-button" onclick="toggleRedeem()" title="å…‘æ¢ç ">ğŸ«</div>

    <!-- å¹¿å‘Šå¼¹çª— -->
    <div id="ad-popup" class="popup">
        <div class="popup-content">
            <h3>ğŸ¥ è§‚çœ‹å¹¿å‘Šè·å¾—å¥–åŠ±</h3>
            <p>è§‚çœ‹å®Œæ•´è§†é¢‘å¯è·å¾—ï¼š</p>
            <p style="color: #FFD700; font-size: 24px;">+10,000é‡‘å¸</p>
            <button class="ad-button" onclick="watchAd()">ç«‹å³è§‚çœ‹</button>
            <button onclick="toggleAd()" class="close-button">å…³é—­</button>
            <div id="ad-status" style="margin-top:10px;"></div>
        </div>
    </div>

    <!-- å…‘æ¢ç å¼¹çª— -->
    <div id="redeem-popup" class="popup">
        <div class="popup-content">
            <h3>ğŸ å…‘æ¢ç </h3>
            <input type="text" id="redeem-code" placeholder="è¾“å…¥å…‘æ¢ç ">
            <button class="redeem-button" onclick="redeemCode()">å…‘æ¢</button>
            <button onclick="toggleRedeem()" class="close-button">å…³é—­</button>
        </div>
    </div>

    <!-- å•†åŸå¼¹çª— -->
    <div id="shop-popup" class="shop-popup">
        <div class="shop-content">
            <h3>ğŸ’ é’»çŸ³å•†åŸ ğŸ’°</h3>
            <div class="exchange-item">
                <div>500é’»çŸ³ â†’ 500,000é‡‘å¸</div>
                <button onclick="exchange(500, 500000)">å…‘æ¢</button>
            </div>
            <div class="exchange-item">
                <div>1000é’»çŸ³ â†’ 1,000,000é‡‘å¸</div>
                <button onclick="exchange(1000, 1000000)">å…‘æ¢</button>
            </div>
            <div class="exchange-item">
                <div>2000é’»çŸ³ â†’ 2,500,000é‡‘å¸</div>
                <button onclick="exchange(2000, 2500000)">å…‘æ¢</button>
            </div>
            <div class="exchange-item">
                <div>5000é’»çŸ³ â†’ 6,000,000é‡‘å¸</div>
                <button onclick="exchange(5000, 6000000)">å…‘æ¢</button>
            </div>
            <div class="exchange-item">
                <div>10000é’»çŸ³ â†’ 13,000,000é‡‘å¸</div>
                <button onclick="exchange(10000, 13000000)">å…‘æ¢</button>
            </div>
            <div class="exchange-item">
                <div>30000é’»çŸ³ â†’ 40,000,000é‡‘å¸</div>
                <button onclick="exchange(30000, 40000000)">å…‘æ¢</button>
            </div>
            <div class="exchange-item">
                <div>60000é’»çŸ³ â†’ 85,000,000é‡‘å¸</div>
                <button onclick="exchange(60000, 85000000)">å…‘æ¢</button>
            </div>
            <div class="exchange-item">
                <div>100000é’»çŸ³ â†’ 140,000,000é‡‘å¸</div>
                <button onclick="exchange(100000, 140000000)">å…‘æ¢</button>
            </div>
            <button onclick="toggleShop()" class="close-shop">å…³é—­</button>
        </div>
    </div>

    <!-- ç™»å½•æ¡† -->
    <div class="auth-box" id="auth-box">
        <h2>ç”¨æˆ·ç™»å½•/æ³¨å†Œ</h2>
        <input type="text" id="username" placeholder="ç”¨æˆ·å">
        <input type="password" id="password" placeholder="å¯†ç ">
        <button onclick="login()">ç™»å½•</button>
        <button onclick="register()">æ³¨å†Œ</button>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div class="container" id="game-container" style="display: none;">
        <div class="game-area">
            <h1>ğŸ’°å¯Œè±ªç‰ˆ21ç‚¹ğŸ’</h1>
            <div class="level-info">
                <div>ğŸ‘‘ç­‰çº§ï¼š<span id="current-level">1</span></div>
                <div>ğŸ›¡ï¸ç»éªŒï¼š<span id="current-exp">0</span></div>
                <div class="diamond-info">ğŸ’é’»çŸ³ï¼š<span id="current-diamonds">0</span></div>
                <div class="progress-bar" style="width:100%">
                    <div class="progress" id="level-progress" style="width: 0%"></div>
                </div>
            </div>
            <div class="money">
                å½“å‰èµ„é‡‘ğŸ’°ï¼šÂ¥<span id="current-money">0</span>
                <span style="margin-left: 15px; color: #4CAF50">
                    æ€»ä¸‹æ³¨ï¼šÂ¥<span id="current-bet">0</span><br>
                    <span style="font-size: 12px">(ä¸»æ³¨ + ä¾§è¾¹æ³¨)</span>
                </span>
            </div>
            
            <!-- ä¾§è¾¹æ³¨é€‰é¡¹ -->
            <div class="sidebet-options">
                <label>
                    <input type="checkbox" id="flush-check">
                    åŒæ—¶æŠ¼åŒèŠ±/é¡ºå­ (1:50ï¼Œä¸»æ³¨5%)
                </label>
                <label>
                    <input type="checkbox" id="three-check">
                    åŒæ—¶æŠ¼ä¸‰åŒæ•°å­— (1:100ï¼Œä¸»æ³¨5%)
                </label>
            </div>

            <!-- ä¸‹æ³¨æŒ‰é’® -->
            <div class="bet-buttons">
                <button onclick="placeBet(5000)">æŠ¼ Â¥5,000ğŸª™</button>
                <button onclick="placeBet(10000)">æŠ¼ Â¥10,000ğŸª™</button>
                <button onclick="placeBet(50000)">æŠ¼ Â¥50,000ğŸ§§</button>
                <button onclick="placeBet(100000)">æŠ¼ Â¥100,000ğŸ§§</button>
                <button onclick="placeBet(300000)">æŠ¼ Â¥300,000ğŸ’¶</button>
                <button onclick="placeBet(500000)">æŠ¼ Â¥500,000ğŸ’¶</button>
                <button onclick="placeBet(1000000)">æŠ¼ Â¥1,000,000ğŸ’µ</button>
                <button onclick="placeBet(5000000)">æŠ¼ Â¥5,000,000ğŸ’µ</button>
                <button onclick="placeBet(10000000)">æŠ¼ Â¥10,000,000ğŸ’</button>
                <button onclick="placeBet(100000000)">æŠ¼ Â¥100,000,000ğŸ’</button>
                <button onclick="placeBet(500000000)">æŠ¼ Â¥500,000,000ğŸ’°</button>
                <button onclick="placeBet(1000000000)">æŠ¼ Â¥1,000,000,000ğŸ’°</button>
                <button onclick="placeBet(5000000000)">æŠ¼ Â¥5,000,000,000ğŸ’³</button>
                <button onclick="placeBet(10000000000)">æŠ¼ Â¥10,000,000,000ğŸ’³</button>
                <button onclick="placeBet(50000000000)">æŠ¼ Â¥50,000,000,000ğŸ”±</button>
                <button onclick="placeBet(100000000000)">æŠ¼ Â¥100,000,000,000ğŸ”±</button>
            </div>

            <!-- æ¸¸æˆæ§åˆ¶ -->
            <div id="game-controls" style="display: none;">
                <div class="cards">
                    <h3>åº„å®¶çš„ç‰Œ (<span id="dealer-score">0</span>)</h3>
                    <div id="dealer-cards"></div>
                </div>
                <div class="cards">
                    <h3>ä½ çš„ç‰Œ (<span id="player-score">0</span>)</h3>
                    <div id="player-cards"></div>
                </div>
                <button onclick="hit()">è¦ç‰Œ</button>
                <button class="double-button" onclick="doubleDown()">DOUBLE åŠ å€</button>
                <button onclick="stand()">åœç‰Œ</button>
                <button onclick="resetGame()">é‡æ–°å¼€å§‹</button>
                <div id="game-result" style="color: #FF5722; font-size: 24px; margin: 15px;"></div>
            </div>
        </div>

        <!-- æ’è¡Œæ¦œ -->
        <div class="leaderboard">
            <h2>ğŸ† å¯Œè±ªæ’è¡Œæ¦œ</h2>
            <ul id="leaderboard-list"></ul>
        </div>
    </div>

    <script>
        // ç³»ç»Ÿé…ç½®
        const levelRequirements = [0, 30, 100, 300, 1000, 5000, 20000, 100000,300000,600000,1000000,3000000,6000000,10000000,30000000,60000000,100000000,300000000,600000000,1000000000,3000000000,6000000000,10000000000,20000000000,50000000000,100000000000];
        const typeNameMap = {
            flush_straight: 'åŒèŠ±/é¡ºå­',
            threeOfAKind: 'ä¸‰åŒæ•°å­—'
        };

        // æ¸¸æˆæ•°æ®
        let users = JSON.parse(localStorage.getItem('blackjackUsers')) || [];
        let currentUser = null;
        let deck = [];
        let dealerHand = [];
        let playerHand = [];
        let currentBet = 0;
        let gameActive = false;
        let initialCards = [];

        // ä¾§è¾¹æ³¨é…ç½®
        let sideBets = {
            flush_straight: {
                amount: 0,
                odds: 50,
                check: function(cards) {
                    return checkFlush(cards) || checkStraight(cards);
                }
            },
            threeOfAKind: {
                amount: 0,
                odds: 100,
                check: checkThreeOfAKind
            }
        };

        // ç”¨æˆ·ç®¡ç†
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const user = users.find(u => u.username === username);
            if (user && user.password === password) {
                currentUser = user;
                startGameSession();
            } else {
                alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
            }
        }

        function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (users.some(u => u.username === username)) {
                alert('ç”¨æˆ·åå·²å­˜åœ¨');
                return;
            }
            const newUser = {
                username,
                password,
                money: 100000,
                diamonds: 0,
                adLastUsed: 0,
                level: 1,
                exp: 0,
                totalExp: 0,
                claimedLevels: [1]
            };
            users.push(newUser);
            localStorage.setItem('blackjackUsers', JSON.stringify(users));
            currentUser = newUser;
            startGameSession();
        }

        // æ¸¸æˆæ ¸å¿ƒé€»è¾‘
        function initializeDeck() {
            deck = [];
            const suits = ['â™ ', 'â™£', 'â™¥', 'â™¦'];
            const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            for (let suit of suits) {
                for (let value of values) {
                    deck.push({ 
                        suit, 
                        value, 
                        color: (suit === 'â™¥' || suit === 'â™¦') ? 'red' : 'white' 
                    });
                }
            }
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        function calculateScore(hand) {
            let score = 0;
            let aceCount = 0;
            for (let card of hand) {
                if (card.value === 'A') {
                    aceCount++;
                    score += 11;
                } else if (['J', 'Q', 'K'].includes(card.value)) {
                    score += 10;
                } else {
                    score += parseInt(card.value);
                }
            }
            while (score > 21 && aceCount > 0) {
                score -= 10;
                aceCount--;
            }
            return score;
        }

        function dealCard(hand) {
            if (deck.length < 10) initializeDeck();
            return hand.push(deck.pop());
        }

        function placeBet(amount) {
            if (!currentUser) return;
            if (gameActive) {
                alert('è¯·å…ˆç»“æŸå½“å‰æ¸¸æˆå†ä¸‹æ³¨ï¼');
                return;
            }
            
            const flushBet = document.getElementById('flush-check').checked;
            const threeBet = document.getElementById('three-check').checked;
            
            let totalBet = amount;
            if (flushBet) totalBet += amount * 0.05;
            if (threeBet) totalBet += amount * 0.05;
            
            if (currentUser.money < totalBet) {
                alert('èµ„é‡‘ä¸è¶³ï¼');
                return;
            }
            
            currentUser.money -= totalBet;
            currentBet = amount;
            sideBets.flush_straight.amount = flushBet ? amount * 0.05 : 0;
            sideBets.threeOfAKind.amount = threeBet ? amount * 0.05 : 0;
            
            updateBetDisplay();
            initializeDeck();
            dealerHand = [];
            playerHand = [];
            dealCard(dealerHand);
            dealCard(playerHand);
            dealCard(playerHand);
            initialCards = [...playerHand, dealerHand[0]];
            gameActive = true;
            document.getElementById('game-controls').style.display = 'block';
            updateDisplay();
        }

        function hit() {
            if (!gameActive) return;
            dealCard(playerHand);
            const playerScore = calculateScore(playerHand);
            updateDisplay();
            if (playerScore > 21) {
                endGame('çˆ†ç‰Œï¼åº„å®¶è·èƒœ');
            }
        }

        function stand() {
            if (!gameActive) return;
            while (calculateScore(dealerHand) < 17) {
                dealCard(dealerHand);
            }
            const dealerScore = calculateScore(dealerHand);
            const playerScore = calculateScore(playerHand);
            
            let result = '';
            if (playerScore > 21) {
                result = 'ç©å®¶çˆ†ç‰Œï¼Œåº„å®¶èµ¢ï¼';
            } else if (dealerScore > 21) {
                result = 'åº„å®¶çˆ†ç‰Œï¼Œç©å®¶èµ¢ï¼';
                currentUser.money += currentBet * 2;
            } else if (playerScore > dealerScore) {
                result = 'ç©å®¶èµ¢ï¼';
                currentUser.money += currentBet * 2;
            } else if (playerScore === dealerScore) {
                result = 'å¹³å±€ï¼';
                currentUser.money += currentBet;
            } else {
                result = 'åº„å®¶èµ¢ï¼';
            }
            endGame(result);
        }

        function endGame(message) {
            gameActive = false;
            checkSideBets();
            updateDisplay();
            
            if (message.includes('èµ¢')) {
                const winAmount = currentBet + Object.values(sideBets)
                    .reduce((total, bet) => total + (bet.amount * bet.odds), 0);
                const earnedExp = Math.floor(winAmount / 1000);
                addExperience(earnedExp);
            }
            
            document.getElementById('game-result').textContent = message;
            updateMoneyDisplay();
            updateLeaderboard();
            saveUserData();
        }

        function checkSideBets() {
            const checkCards = initialCards;
            for (let type in sideBets) {
                const bet = sideBets[type];
                if (bet.amount > 0 && bet.check(checkCards)) {
                    const winnings = bet.amount * bet.odds;
                    currentUser.money += winnings + bet.amount;
                    alert(`${typeNameMap[type]} ä¸­å¥–ï¼\nä¸‹æ³¨é‡‘é¢ï¼šÂ¥${bet.amount.toLocaleString()}\nè·å¾—å¥–é‡‘ï¼šÂ¥${winnings.toLocaleString()}\næ€»è¿”è¿˜ï¼šÂ¥${(winnings + bet.amount).toLocaleString()}`);
                }
                bet.amount = 0;
            }
            updateBetDisplay();
        }

        function checkFlush(cards) {
            return cards.length >= 3 && cards.every(c => c.suit === cards[0].suit);
        }

        function checkStraight(cards) {
            if (cards.length < 3) return false;
            const values = cards.map(c => {
                switch(c.value) {
                    case 'A': return 14;
                    case 'K': return 13;
                    case 'Q': return 12;
                    case 'J': return 11;
                    default: return parseInt(c.value);
                }
            }).sort((a, b) => a - b);
            if (values.includes(14) && values.includes(2) && values.includes(3)) return true;
            return (values[2] - values[1] === 1 && values[1] - values[0] === 1);
        }

        function checkThreeOfAKind(cards) {
            return cards.length >= 3 && cards.every(c => c.value === cards[0].value);
        }

        function resetGame() {
            gameActive = false;
            currentBet = 0;
            sideBets.flush_straight.amount = 0;
            sideBets.threeOfAKind.amount = 0;
            updateBetDisplay();
            dealerHand = [];
            playerHand = [];
            document.getElementById('game-controls').style.display = 'none';
            document.getElementById('game-result').textContent = '';
            updateDisplay();
        }

        function doubleDown() {
            if (!gameActive || currentBet === 0) return;
            if (currentUser.money < currentBet) {
                alert('èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•åŠ å€ï¼');
                return;
            }
            currentUser.money -= currentBet;
            currentBet *= 2;
            updateBetDisplay();
            updateMoneyDisplay();
            dealCard(playerHand);
            updateDisplay();
            stand();
        }

        function updateDisplay() {
            document.getElementById('dealer-cards').innerHTML = dealerHand.map((card, index) => {
                if (index === 0 && gameActive) {
                    return '<span class="card-symbol" style="background: #555">ğŸ‚ </span>';
                } else {
                    return `<span class="card-symbol" style="color: ${card.color}">${card.value}${card.suit}</span>`;
                }
            }).join('');

            document.getElementById('player-cards').innerHTML = playerHand.map(card => 
                `<span class="card-symbol" style="color: ${card.color}">${card.value}${card.suit}</span>`
            ).join('');

            document.getElementById('dealer-score').textContent = gameActive ? 
                calculateScore([dealerHand[0]]) : 
                calculateScore(dealerHand);
            document.getElementById('player-score').textContent = calculateScore(playerHand);
        }

        function updateMoneyDisplay() {
            document.getElementById('current-money').textContent = currentUser.money.toLocaleString('zh-CN');
        }

        function updateBetDisplay() {
            const totalBet = currentBet + sideBets.flush_straight.amount + sideBets.threeOfAKind.amount;
            document.getElementById('current-bet').textContent = totalBet.toLocaleString('zh-CN');
        }

        function addExperience(amount) {
            const originalLevel = currentUser.level;
            currentUser.totalExp += amount;
            
            let levelsGained = 0;
            while (
                currentUser.level < levelRequirements.length - 1 && 
                currentUser.totalExp >= levelRequirements[currentUser.level]
            ) {
                currentUser.level++;
                levelsGained++;
            }
            
            if(levelsGained > 0) {
                let totalDiamonds = 0;
                for(let i=1; i<=levelsGained; i++) {
                    const targetLevel = originalLevel + i;
                    let diamonds = 0;
                    if(targetLevel === 2) {
                        diamonds = 50;
                    } else if(targetLevel >= 3) {
                        diamonds = 100 * Math.pow(2, targetLevel - 3);
                    }
                    totalDiamonds += diamonds;
                }
                
                currentUser.diamonds += totalDiamonds;
                showFloatingMessage(
                    `ğŸ† å‡çº§åˆ° Lv.${currentUser.level}\n` +
                    `è·å¾—é’»çŸ³ ğŸ’x${totalDiamonds}`
                );
                updateDiamondDisplay();
            }
            
            updateLevelDisplay();
            saveUserData();
        }

        function updateDiamondDisplay() {
            document.getElementById('current-diamonds').textContent = currentUser.diamonds;
        }

        function updateLevelDisplay() {
            const levelElement = document.getElementById('current-level');
            const expElement = document.getElementById('current-exp');
            
            if (!levelElement || !expElement) return;
            
            levelElement.textContent = currentUser.level;
            expElement.textContent = currentUser.totalExp;
            
            const maxLevel = levelRequirements.length - 1;
            if(currentUser.level >= maxLevel) {
                document.getElementById('level-progress').style.width = '100%';
                return;
            }
            
            const currentReq = levelRequirements[currentUser.level];
            const prevReq = levelRequirements[currentUser.level - 1] || 0;
            const progress = ((currentUser.totalExp - prevReq) / (currentReq - prevReq)) * 100;
            
            document.getElementById('level-progress').style.width = `${Math.min(100, progress)}%`;
        }

        function saveUserData() {
            localStorage.setItem('blackjackUsers', JSON.stringify(users));
        }

        function updateLeaderboard() {
            const sorted = [...users].sort((a, b) => b.money - a.money).slice(0, 10);
            document.getElementById('leaderboard-list').innerHTML = sorted
                .map((user, index) => `
                    <li>${index + 1}. ${user.username} - Â¥${user.money.toLocaleString('zh-CN')}</li>
                `).join('');
        }

        function startGameSession() {
            document.getElementById('auth-box').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            updateMoneyDisplay();
            updateLevelDisplay();
            updateDiamondDisplay();
            initializeDeck();
            updateLeaderboard();
        }

        function showFloatingMessage(text) {
            const msg = document.createElement('div');
            msg.style.cssText = `
                position: fixed;
                top: 20%;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,200,50,0.9);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                z-index: 9999;
                animation: floatUp 1.5s ease-out;
                text-align: center;
                white-space: pre-line;
            `;
            msg.innerHTML = text;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 2500);
        }

        // æ–°å¢åŠŸèƒ½
        function toggleShop() {
            const shop = document.getElementById('shop-popup');
            shop.style.display = shop.style.display === 'block' ? 'none' : 'block';
        }

        function toggleAd() {
            const popup = document.getElementById('ad-popup');
            popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
        }

        function toggleRedeem() {
            const popup = document.getElementById('redeem-popup');
            popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
        }

        async function watchAd() {
            try {
                document.getElementById('ad-status').innerHTML = "â³ å¹¿å‘ŠåŠ è½½ä¸­...";
                await new Promise(resolve => setTimeout(resolve, 2000));
                document.getElementById('ad-status').innerHTML = "â–¶ï¸ æ­£åœ¨æ’­æ”¾å¹¿å‘Š...";
                await new Promise(resolve => setTimeout(resolve, 10000));
                currentUser.money += 10000;
                updateMoneyDisplay();
                saveUserData();
                document.getElementById('ad-status').innerHTML = "âœ… è·å¾—10,000é‡‘å¸ï¼";
            } finally {
                setTimeout(() => {
                    toggleAd();
                    document.getElementById('ad-status').innerHTML = "";
                }, 3000);
            }
        }

        function redeemCode() {
            const code = document.getElementById('redeem-code').value;
            if (code === "VIP888") {
                if (currentUser) {
                    currentUser.money += 100000;
                    updateMoneyDisplay();
                    saveUserData();
                    showFloatingMessage("å…‘æ¢æˆåŠŸï¼è·å¾—10,000é‡‘å¸ï¼");
                    toggleRedeem();
                } else {
                    alert("è¯·å…ˆç™»å½•ï¼");
                }
            } else {
                alert("æ— æ•ˆçš„å…‘æ¢ç ï¼");
            }
        }

        function exchange(requiredDiamonds, getCoins) {
            if (!currentUser) return alert("è¯·å…ˆç™»å½•ï¼");
            if (currentUser.diamonds >= requiredDiamonds) {
                currentUser.diamonds -= requiredDiamonds;
                currentUser.money += getCoins;
                updateMoneyDisplay();
                updateDiamondDisplay();
                saveUserData();
                showFloatingMessage(`å…‘æ¢æˆåŠŸï¼è·å¾— ${getCoins.toLocaleString()}é‡‘å¸`);
                toggleShop();
            } else {
                alert(`é’»çŸ³ä¸è¶³ï¼éœ€è¦${requiredDiamonds}é’»çŸ³`);
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        initializeDeck();
    </script>
</body>
</html>
